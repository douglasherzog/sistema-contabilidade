{% extends 'base.html' %}
{% block title %}Início - Sistema Contabilidade{% endblock %}
{% block content %}
<div class="lav-page-header">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h1 class="h4 mb-1 lav-page-title">Painel do mês</h1>
      <div class="small lav-subtitle">Uma visão rápida do que está pendente para fechar a competência com segurança.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-primary btn-sm" href="{{ url_for('payroll.monthly_guide') }}">Abrir Modo Guiado</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('payroll.help_page', slug='painel') }}">Ajuda desta tela</a>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Competência</h2>
      <div class="lav-meta">Mês atual por padrão, mas você pode selecionar outro.</div>
    </div>

    <form method="get" action="{{ url_for('main.index') }}" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label" for="year">Ano</label>
        <input class="form-control" id="year" name="year" value="{{ year }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="month">Mês</label>
        <input class="form-control" id="month" name="month" value="{{ month }}" required>
      </div>
      <div class="col-md-6">
        {% if status.competence.closed %}
          <div class="lav-meta">Status: <strong>fechada</strong> (com aviso)</div>
        {% else %}
          <div class="lav-meta">Status: <strong>em aberto</strong></div>
        {% endif %}
      </div>
      <div class="col-12">
        <button class="btn btn-outline-secondary" type="submit">Abrir competência</button>
      </div>
    </form>
  </div>
</div>

<div class="lav-callout is-info mb-3">
  <strong>Próximo passo sugerido</strong>
  <div class="small">{{ next_step.help }}</div>
  <div class="mt-2">
    <a class="btn btn-sm btn-primary" href="{{ next_step.url }}">{{ next_step.label }}</a>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Score de risco da competência</h2>
      <div class="lav-meta">0 (baixo) a 100 (alto), com base em bloqueios e prazos críticos</div>
    </div>
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <div class="small text-muted">Nível</div>
        {% if competence_risk.level == 'red' %}
          <span class="badge text-bg-danger">{{ competence_risk.level_label }}</span>
        {% elif competence_risk.level == 'yellow' %}
          <span class="badge text-bg-warning">{{ competence_risk.level_label }}</span>
        {% else %}
          <span class="badge text-bg-success">{{ competence_risk.level_label }}</span>
        {% endif %}
      </div>
      <div class="text-end">
        <div class="small text-muted">Score</div>
        <div class="h4 mb-0">{{ competence_risk.score }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Centro único de pendências (SLA)</h2>
      <div class="lav-meta">Fila priorizada com o que precisa ser resolvido para reduzir risco</div>
    </div>
    {% if pending_center %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Faixa</th>
              <th>SLA</th>
              <th>Vencimento</th>
              <th class="lav-th-fit"></th>
            </tr>
          </thead>
          <tbody>
            {% for row in pending_center %}
            <tr>
              <td>{{ row.title }}</td>
              <td>
                {% if row.bucket == 'blocked' %}
                  <span class="badge text-bg-dark">Bloqueador</span>
                {% elif row.bucket == 'overdue' %}
                  <span class="badge text-bg-danger">Atrasado</span>
                {% elif row.bucket == 'today' %}
                  <span class="badge text-bg-warning">Hoje</span>
                {% else %}
                  <span class="badge text-bg-primary">Próx. 7 dias</span>
                {% endif %}
              </td>
              <td class="small text-muted">{{ row.sla }}</td>
              <td class="small text-muted">{{ row.due_date|fmt_date }}</td>
              <td>
                {% if row.action_url %}
                <a class="btn btn-sm btn-outline-primary" href="{{ row.action_url }}">{{ row.action_label }}</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="lav-callout is-success mb-0">
        <strong>Sem pendências críticas no momento.</strong>
      </div>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Ação de hoje (automática)</h2>
      <div class="lav-meta">Prioriza o que vence hoje ou está em atraso</div>
    </div>

    {% if proactive_action %}
      <div class="lav-callout is-warning mb-2">
        <strong>{{ proactive_action.title }}</strong>
        <div class="small">{{ proactive_action.reminder }}</div>
      </div>
      <a class="btn btn-sm btn-primary" href="{{ proactive_action.action_url }}">{{ proactive_action.action_label }}</a>
    {% else %}
      <div class="lav-callout is-success mb-0">
        <strong>Nenhuma obrigação crítica hoje.</strong>
        <div class="small">Continue acompanhando a semana para evitar pendências de última hora.</div>
      </div>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Resumo semanal automático</h2>
      <div class="lav-meta">Visão rápida das obrigações para agir cedo</div>
    </div>

    <div class="row g-3 mb-2">
      <div class="col-md-4">
        <div class="small text-muted">Atrasados</div>
        <div><strong>{{ weekly_summary.overdue_count }}</strong></div>
      </div>
      <div class="col-md-4">
        <div class="small text-muted">Vencem hoje</div>
        <div><strong>{{ weekly_summary.today_count }}</strong></div>
      </div>
      <div class="col-md-4">
        <div class="small text-muted">Próximos 7 dias</div>
        <div><strong>{{ weekly_summary.next_7_days_count }}</strong></div>
      </div>
    </div>

    {% if weekly_summary.last_compliance %}
      <div class="small">
        Último compliance-check: 
        {% if weekly_summary.last_compliance.ok %}
          <span class="badge text-bg-success">sem alertas</span>
        {% else %}
          <span class="badge text-bg-warning">{{ weekly_summary.last_compliance.issues_count }} alerta(s)</span>
        {% endif %}
        <span class="text-muted">({{ weekly_summary.last_compliance.target_month }}/{{ weekly_summary.last_compliance.target_year }} em {{ weekly_summary.last_compliance.ran_at }})</span>
      </div>
    {% else %}
      <div class="small text-muted">Último compliance-check: ainda não executado nesta sessão.</div>
    {% endif %}

    {% if overdue_items %}
      <hr>
      <div class="small text-muted mb-1">Pendências críticas em atraso:</div>
      <div class="small">
        {% for item in overdue_items %}
          <div><strong>{{ item.title }}</strong> — {{ item.reminder }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Resumo executivo semanal</h2>
      <div class="lav-meta">Consolidação de risco, pendências e alertas regulatórios da competência</div>
    </div>
    <div class="row g-3">
      <div class="col-md-3">
        <div class="small text-muted">Risco da competência</div>
        <div><strong>{{ executive_summary.risk_level }}</strong> ({{ executive_summary.risk_score }})</div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Pendências totais</div>
        <div><strong>{{ executive_summary.pending_total }}</strong></div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Bloqueadores</div>
        <div><strong>{{ executive_summary.blocked_count }}</strong></div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Alertas legais/fiscais</div>
        <div><strong>{{ executive_summary.legal_alerts_count }}</strong></div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Monitor de mudanças legais/fiscais</h2>
      <div class="lav-meta">Sinais automáticos de risco por vigência de tabelas e situação das guias</div>
    </div>
    <div class="small">
      {% for alert in legal_monitor %}
        <div class="mb-2">
          {% if alert.level == 'danger' %}
            <span class="badge text-bg-danger">Crítico</span>
          {% elif alert.level == 'warning' %}
            <span class="badge text-bg-warning">Atenção</span>
          {% else %}
            <span class="badge text-bg-success">OK</span>
          {% endif %}
          <strong>{{ alert.title }}</strong>
          <div class="text-muted">{{ alert.detail }}</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Status rápido</h2>
      <div class="lav-meta">Objetivo: ver o que está OK e o que falta.</div>
    </div>

    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card h-100 lav-check-card {% if status.revenue.ok %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Receitas / notas</h3>
              {% if status.revenue.ok %}
                <span class="badge text-bg-success">OK</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">Registradas: <strong>{{ status.revenue.count }}</strong></div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.revenue.action_url }}">Abrir Receitas</a>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card h-100 lav-check-card {% if status.payroll.ok %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Folha</h3>
              {% if status.payroll.ok %}
                <span class="badge text-bg-success">OK</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">Crie/abra a folha para lançar horas extras e gerar holerites.</div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.payroll.action_url }}">Abrir Folha</a>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card h-100 lav-check-card {% if status.taxes.ok %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Tabelas INSS/IRRF</h3>
              {% if status.taxes.ok %}
                <span class="badge text-bg-success">OK</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
            </div>
            <div class="lav-meta mb-3">
              INSS: {{ status.taxes.inss_eff|fmt_date }}<br>
              IRRF: {{ status.taxes.irrf_eff|fmt_date }}
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.taxes.action_url }}">Config INSS/IRRF</a>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 lav-check-card {% if status.guides.ok %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Guias (DAS/FGTS/DARF)</h3>
              {% if status.guides.ok %}
                <span class="badge text-bg-success">OK</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">Centralize valores, vencimentos e PDFs para conferir antes de pagar.</div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.guides.action_url }}">Abrir Fechamento</a>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 lav-check-card {% if status.close.ok %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Competência</h3>
              {% if status.close.ok %}
                <span class="badge text-bg-success">OK</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">Quando estiver tudo conferido, marque como fechada para organização (com aviso).</div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.close.action_url }}">Abrir Fechamento</a>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 lav-check-card {% if status.vacations.count > 0 %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Férias no mês</h3>
              {% if status.vacations.count > 0 %}
                <span class="badge text-bg-success">{{ status.vacations.count }}</span>
              {% else %}
                <span class="badge text-bg-secondary">0</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">
              {% if status.vacations.count > 0 %}
                Total bruto: <strong>R$ {{ '%.2f'|format(status.vacations.total_gross or 0) }}</strong>
              {% else %}
                Nenhuma férias registrada para este mês.
              {% endif %}
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.vacations.action_url }}">Ver funcionários</a>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 lav-check-card {% if status.thirteenth.count > 0 %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">13º no mês</h3>
              {% if status.thirteenth.count > 0 %}
                <span class="badge text-bg-success">{{ status.thirteenth.count }}</span>
              {% else %}
                <span class="badge text-bg-secondary">0</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">
              {% if status.thirteenth.count > 0 %}
                Total bruto: <strong>R$ {{ '%.2f'|format(status.thirteenth.total_gross or 0) }}</strong>
              {% else %}
                Nenhum 13º registrado para este mês.
              {% endif %}
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.thirteenth.action_url }}">Ver funcionários</a>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 lav-check-card {% if status.terminations.count > 0 %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Rescisões no mês</h3>
              {% if status.terminations.count > 0 %}
                <span class="badge text-bg-success">{{ status.terminations.count }}</span>
              {% else %}
                <span class="badge text-bg-secondary">0</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">
              {% if status.terminations.count > 0 %}
                Total bruto: <strong>R$ {{ '%.2f'|format(status.terminations.total_gross or 0) }}</strong>
              {% else %}
                Nenhuma rescisão registrada para este mês.
              {% endif %}
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.terminations.action_url }}">Ver funcionários</a>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 lav-check-card {% if status.leaves.count > 0 %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">Afastamentos no mês</h3>
              {% if status.leaves.count > 0 %}
                <span class="badge text-bg-success">{{ status.leaves.count }}</span>
              {% else %}
                <span class="badge text-bg-secondary">0</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">
              {% if status.leaves.count > 0 %}
                Há registros de afastamento para conferência.
              {% else %}
                Nenhum afastamento registrado para este mês.
              {% endif %}
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ status.leaves.action_url }}">Ver funcionários</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
