{% extends 'base.html' %}
{% block title %}Fechamento - Sistema Contabilidade{% endblock %}
{% block content %}
<div class="lav-page-header">
  <div class="lav-section-title">
    <div>
      <h1 class="h4 mb-1 lav-page-title">Fechamento</h1>
      <div class="small lav-subtitle">Checklist do mês para você conferir se está tudo pronto antes de pagar as guias e encerrar a competência.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('payroll.monthly_guide', year=year, month=month) }}">Modo Guiado</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('payroll.help_page', slug='fechamento') }}">Ajuda desta tela</a>
      {% if closed %}
        <form method="post" action="{{ url_for('payroll.close_reopen') }}">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <button class="btn btn-outline-secondary" type="submit">Reabrir competência</button>
        </form>
      {% else %}
        <form method="post" action="{{ url_for('payroll.close_mark') }}">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <button class="btn btn-primary" type="submit">Marcar como fechada</button>
        </form>
      {% endif %}
    </div>
  </div>

  {% if closed %}
    <div class="lav-callout is-warning mt-3">
      <strong>Competência marcada como FECHADA.</strong>
      <div class="small">Isso não bloqueia alterações, mas o sistema vai te avisar quando você mexer em dados do mês para evitar inconsistências.</div>
    </div>
  {% else %}
    <div class="lav-callout mt-3">
      <strong>Competência em aberto.</strong>
      <div class="small lav-subtitle">Quando tudo estiver OK no checklist abaixo, você pode marcar como fechada para organização.</div>
    </div>
  {% endif %}
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Competência</h2>
      <div class="lav-meta">Use este seletor para abrir outro mês/ano.</div>
    </div>

    <form method="get" action="{{ url_for('payroll.close_home') }}" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label" for="year">Ano</label>
        <input class="form-control" id="year" name="year" value="{{ year }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="month">Mês</label>
        <input class="form-control" id="month" name="month" value="{{ month }}" required>
      </div>
      <div class="col-12">
        <button class="btn btn-outline-secondary" type="submit">Abrir competência</button>
      </div>
    </form>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Compliance-check (auditoria rápida)</h2>
      <div class="lav-meta">Verifica regras trabalhistas e consistência fiscal antes do fechamento</div>
    </div>
    <div class="small lav-subtitle mb-3">
      Use primeiro o modo padrão para auditar. Se as tabelas INSS/IRRF estiverem incompletas, você pode habilitar a atualização automática durante a checagem.
    </div>

    <form method="post" action="{{ url_for('payroll.close_run_compliance') }}" class="d-flex gap-2 flex-wrap">
      <input type="hidden" name="year" value="{{ year }}">
      <input type="hidden" name="month" value="{{ month }}">
      <button class="btn btn-outline-primary" type="submit" name="apply_sync" value="0">Rodar compliance-check</button>
      <button class="btn btn-primary" type="submit" name="apply_sync" value="1">Rodar + atualizar tabelas fiscais</button>
    </form>

    {% if compliance_result %}
      <hr>
      <div class="small mb-2">
        {% if compliance_result.ok %}
          <span class="badge text-bg-success">Sem alertas</span>
        {% else %}
          <span class="badge text-bg-warning">{{ compliance_result.issues_count }} alerta(s)</span>
        {% endif %}
      </div>

      {% if compliance_result.sync_report_lines %}
        <label class="form-label" for="sync_report_close">Relatório da atualização fiscal</label>
        <textarea id="sync_report_close" class="form-control mb-2" rows="8" readonly>{% for ln in compliance_result.sync_report_lines %}{{ ln }}
{% endfor %}</textarea>
      {% endif %}

      <label class="form-label" for="compliance_report_close">Relatório do compliance-check</label>
      <textarea id="compliance_report_close" class="form-control" rows="8" readonly>{% for ln in compliance_result.report_lines %}{{ ln }}
{% endfor %}</textarea>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Prazos legais do mês (semáforo)</h2>
      <div class="lav-meta">Verde = no prazo, amarelo = vence em breve, vermelho = atrasado</div>
    </div>
    <div class="small lav-subtitle mb-3">
      Estes prazos apoiam sua rotina de fechamento. Quando houver guia oficial com vencimento preenchido, ela prevalece no cálculo de status.
    </div>

    <div class="row g-3">
      {% for item in legal_deadlines %}
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">{{ item.title }}</h3>
              {% if item.status == 'danger' %}
                <span class="badge text-bg-danger">Atrasado</span>
              {% elif item.status == 'warning' %}
                <span class="badge text-bg-warning">Vence em breve</span>
              {% else %}
                <span class="badge text-bg-success">No prazo</span>
              {% endif %}
            </div>

            <div class="small text-muted">Vencimento: {{ item.due_date|fmt_date }}</div>
            <div class="small text-muted">Pago em: {{ item.paid_at|fmt_date }}</div>
            <div class="small mt-2">{{ item.note }}</div>
            <div class="lav-meta mt-2">{{ item.source }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Checklist guiado</h2>
      <div class="lav-meta">Objetivo: deixar tudo conferido antes de pagar.</div>
    </div>
    <div class="small lav-subtitle mb-3">Cada card abaixo diz o que está pendente e te leva direto para a tela certa.</div>

    <div class="row g-3">
      {% for key, item in checklist.items() %}
      <div class="col-lg-4">
        <div class="card h-100 lav-check-card {% if item.ok %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">{{ item.title }}</h3>
              {% if item.ok %}
                <span class="badge text-bg-success">OK</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">{{ item.help }}</div>

            {% if key == 'taxes' and item.meta %}
              <div class="lav-meta mb-3">
                INSS: {{ item.meta.inss_eff|fmt_date }}<br>
                IRRF: {{ item.meta.irrf_eff|fmt_date }}
              </div>
            {% endif %}

            {% if key == 'vacations' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registradas: {{ item.meta.count }} · Total bruto: R$ {{ '%.2f'|format(item.meta.total_gross or 0) }}
              </div>
            {% endif %}

            {% if key == 'thirteenth' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registrados: {{ item.meta.count }} · Total bruto: R$ {{ '%.2f'|format(item.meta.total_gross or 0) }}
              </div>
            {% endif %}

            {% if key == 'terminations' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registradas: {{ item.meta.count }} · Total bruto: R$ {{ '%.2f'|format(item.meta.total_gross or 0) }}
              </div>
            {% endif %}

            {% if key == 'leaves' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registros: {{ item.meta.count }}
              </div>
            {% endif %}

            <a class="btn btn-sm btn-outline-primary" href="{{ item.action_url }}">{{ item.action_label }}</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Resumo do mês (estimativa)</h2>
      <div class="lav-meta">Conferência rápida</div>
    </div>
    <div class="small lav-subtitle mb-3">
      Este resumo ajuda você a conferir o mês rapidamente. Os valores de INSS/IRRF aqui são <strong>estimativas</strong> baseadas na folha e nas tabelas configuradas.
    </div>

    {% if not summary %}
      <div class="text-muted small">Ainda não existe folha para esta competência. Crie a folha para ver o resumo.</div>
    {% else %}
      <div class="row g-3">
        <div class="col-md-3">
          <div class="small text-muted">Funcionários na folha</div>
          <div><strong>{{ summary.employees_count }}</strong></div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Total bruto</div>
          <div><strong>R$ {{ '%.2f'|format(summary.total_gross or 0) }}</strong></div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">INSS estimado (empregado)</div>
          <div>
            {% if summary.total_inss_est is none %}
              <span class="text-muted">— (tabelas não configuradas)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_inss_est) }}</strong>
            {% endif %}
          </div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">IRRF estimado</div>
          <div>
            {% if summary.total_irrf_est is none %}
              <span class="text-muted">— (tabelas/config não configuradas)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_irrf_est) }}</strong>
            {% endif %}
          </div>
        </div>
      </div>

      {% if vacations_summary and vacations_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">Férias no mês</div>
          <div><strong>{{ vacations_summary.count }}</strong> registro(s) · Total bruto: <strong>R$ {{ '%.2f'|format(vacations_summary.total_gross or 0) }}</strong></div>
        </div>
      </div>
      {% endif %}

      {% if thirteenth_summary and thirteenth_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">13º no mês</div>
          <div><strong>{{ thirteenth_summary.count }}</strong> registro(s) · Total bruto: <strong>R$ {{ '%.2f'|format(thirteenth_summary.total_gross or 0) }}</strong></div>
        </div>
      </div>
      {% endif %}

      {% if terminations_summary and terminations_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">Rescisões no mês</div>
          <div><strong>{{ terminations_summary.count }}</strong> registro(s) · Total bruto: <strong>R$ {{ '%.2f'|format(terminations_summary.total_gross or 0) }}</strong></div>
        </div>
      </div>
      {% endif %}

      {% if leaves_summary and leaves_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">Afastamentos no mês</div>
          <div><strong>{{ leaves_summary.count }}</strong> registro(s)</div>
        </div>
      </div>
      {% endif %}

      <hr>

      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="small text-muted">Líquido estimado (bruto - INSS - IRRF)</div>
          <div>
            {% if summary.total_net_est is none %}
              <span class="text-muted">— (configure as tabelas para calcular)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_net_est) }}</strong>
            {% endif %}
          </div>
        </div>
        <div class="lav-meta text-end">
          INSS: {{ summary.inss_eff|fmt_date }}<br>
          IRRF: {{ summary.irrf_eff|fmt_date }}
        </div>
      </div>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Guias do mês</h2>
      <div class="lav-meta">DAS, FGTS e Previdência</div>
    </div>
    <div class="small lav-subtitle mb-3">Objetivo: centralizar PDFs e valores para você conferir antes de pagar.</div>

    <div class="row g-3">
  {% for dtype, label in { 'darf': 'DARF (Receita Federal)', 'das': 'DAS (Simples Nacional)', 'fgts': 'FGTS Digital (GFD)' }.items() %}
  {% set doc = docs.get(dtype) %}
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h6 mb-1">{{ label }}</h2>
        <div class="small text-muted mb-3">{{ '%02d'|format(month) }}/{{ year }}</div>

        {% if doc %}
          <div class="mb-2">
            {% if doc.filename %}
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="/media/guides/{{ doc.filename }}">Abrir PDF</a>
            {% else %}
              <span class="text-muted small">PDF ainda não anexado.</span>
            {% endif %}
          </div>
          <div class="small text-muted">Valor: {{ ('R$ %.2f'|format(doc.amount)) if doc.amount else '-' }}</div>
          <div class="small text-muted">Vencimento: {{ doc.due_date|fmt_date }}</div>
          <div class="small text-muted mb-3">Pago em: {{ doc.paid_at|fmt_date }}</div>
        {% else %}
          <div class="text-muted small mb-3">Nenhuma informação registrada ainda.</div>
        {% endif %}

        <form method="post" action="{{ url_for('payroll.close_upload') }}" enctype="multipart/form-data">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <input type="hidden" name="doc_type" value="{{ dtype }}">

          <div class="mb-2">
            <label class="form-label" for="file_{{ dtype }}">PDF</label>
            <input class="form-control" type="file" id="file_{{ dtype }}" name="file" accept="application/pdf">
          </div>
          <div class="mb-2">
            <label class="form-label" for="amount_{{ dtype }}">Valor (opcional)</label>
            <input class="form-control js-money" id="amount_{{ dtype }}" name="amount" placeholder="Ex.: 392,41">
          </div>
          <div class="mb-2">
            <label class="form-label" for="due_{{ dtype }}">Vencimento (opcional)</label>
            <input class="form-control js-date" type="text" id="due_{{ dtype }}" name="due_date" placeholder="dd/mm/aaaa" inputmode="numeric">
          </div>
          <div class="mb-3">
            <label class="form-label" for="paid_{{ dtype }}">Pago em (opcional)</label>
            <input class="form-control js-date" type="text" id="paid_{{ dtype }}" name="paid_at" placeholder="dd/mm/aaaa" inputmode="numeric">
          </div>
          <button class="btn btn-primary" type="submit">Salvar</button>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
  </div>
</div>
{% endblock %}
