{% extends 'base.html' %}
{% block title %}Fechamento - Sistema Contabilidade{% endblock %}
{% block content %}
<div class="lav-page-header">
  <div class="lav-section-title">
    <div>
      <h1 class="h4 mb-1 lav-page-title">Fechamento</h1>
      <div class="small lav-subtitle">Checklist do mês para você conferir se está tudo pronto antes de pagar as guias e encerrar a competência.</div>

<div class="card mb-3 border-primary">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 mb-0">Assistente IA do fechamento</h2>
      <span class="badge text-bg-light border">Beta</span>
    </div>
    <div class="small text-muted mb-2">
      Pergunte em linguagem simples. Exemplo: "qual é a prioridade agora para eu fechar esse mês sem risco?"
    </div>
    <textarea id="ai-question-close" class="form-control mb-2" rows="3" placeholder="Digite sua pergunta..."></textarea>
    <div class="d-flex gap-2 mb-2">
      <button id="ai-ask-close" class="btn btn-sm btn-primary" type="button">Perguntar à IA</button>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('payroll.help_page', slug='operacao_mensal_lavanderia') }}">Abrir tutorial</a>
    </div>
    <div id="ai-answer-close" class="small text-muted">A resposta aparecerá aqui.</div>
  </div>
</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-primary btn-sm" href="{{ url_for('payroll.help_page', slug='operacao_mensal_lavanderia') }}">Tutorial mensal completo</a>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('payroll.monthly_guide', year=year, month=month) }}">Modo Guiado</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('payroll.help_page', slug='fechamento') }}">Ajuda desta tela</a>
      {% if closed %}
        <form method="post" action="{{ url_for('payroll.close_reopen') }}">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <button class="btn btn-outline-secondary" type="submit">Reabrir competência</button>
        </form>
      {% else %}
        <form method="post" action="{{ url_for('payroll.close_mark') }}">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <button class="btn btn-primary" type="submit">Marcar como fechada</button>
        </form>
      {% endif %}
    </div>
  </div>

  {% if closed %}
    <div class="lav-callout is-warning mt-3">
      <strong>Competência marcada como FECHADA.</strong>
      <div class="small">Isso não bloqueia alterações, mas o sistema vai te avisar quando você mexer em dados do mês para evitar inconsistências.</div>
    </div>
  {% else %}
    <div class="lav-callout mt-3">
      <strong>Competência em aberto.</strong>
      <div class="small lav-subtitle">Quando tudo estiver OK no checklist abaixo, você pode marcar como fechada para organização.</div>
    </div>
  {% endif %}
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Competência</h2>
      <div class="lav-meta">Use este seletor para abrir outro mês/ano.</div>
    </div>

    <form method="get" action="{{ url_for('payroll.close_home') }}" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label" for="year">Ano</label>
        <input class="form-control" id="year" name="year" value="{{ year }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="month">Mês</label>
        <input class="form-control" id="month" name="month" value="{{ month }}" required>
      </div>
      <div class="col-12">
        <button class="btn btn-outline-secondary" type="submit">Abrir competência</button>
      </div>
    </form>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Score de risco da competência</h2>
      <div class="lav-meta">0 (baixo) a 100 (alto), com base no checklist e nas pendências com SLA</div>
    </div>
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <div class="small text-muted">Nível</div>
        {% if competence_risk.level == 'red' %}
          <span class="badge text-bg-danger">{{ competence_risk.level_label }}</span>
        {% elif competence_risk.level == 'yellow' %}
          <span class="badge text-bg-warning">{{ competence_risk.level_label }}</span>
        {% else %}
          <span class="badge text-bg-success">{{ competence_risk.level_label }}</span>
        {% endif %}
      </div>
      <div class="text-end">
        <div class="small text-muted">Score</div>
        <div class="h4 mb-0">{{ competence_risk.score }}</div>
      </div>
    </div>
    <div class="small">
      {% for reason in competence_risk.reasons %}
        <div>{{ reason }}</div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Centro único de pendências (SLA)</h2>
      <div class="lav-meta">Prioridade automática para resolver bloqueios, atrasos e vencimentos críticos</div>
    </div>
    {% if pending_center %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Faixa</th>
              <th>SLA</th>
              <th>Vencimento</th>
              <th class="lav-th-fit"></th>
            </tr>
          </thead>
          <tbody>
            {% for row in pending_center %}
            <tr>
              <td>{{ row.title }}</td>
              <td>
                {% if row.bucket == 'blocked' %}
                  <span class="badge text-bg-dark">Bloqueador</span>
                {% elif row.bucket == 'overdue' %}
                  <span class="badge text-bg-danger">Atrasado</span>
                {% elif row.bucket == 'today' %}
                  <span class="badge text-bg-warning">Hoje</span>
                {% else %}
                  <span class="badge text-bg-primary">Próx. 7 dias</span>
                {% endif %}
              </td>
              <td class="small text-muted">{{ row.sla }}</td>
              <td class="small text-muted">{{ row.due_date|fmt_date }}</td>
              <td>
                {% if row.action_url %}
                <a class="btn btn-sm btn-outline-primary" href="{{ row.action_url }}">{{ row.action_label }}</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="lav-callout is-success mb-0">
        <strong>Sem pendências críticas no momento.</strong>
        <div class="small">Continue acompanhando a agenda para manter o fechamento sob controle.</div>
      </div>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Agenda automática de obrigações</h2>
      <div class="lav-meta">Lembretes proativos: hoje, próximos 7 dias e atrasados</div>
    </div>
    <div class="small lav-subtitle mb-3">
      O sistema monta esta agenda automaticamente com base na competência e nos vencimentos das guias. Use os botões para resolver cada item no momento certo.
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <div class="card h-100 border-danger">
          <div class="card-body">
            <div class="small text-muted">Atrasados</div>
            <div class="h5 mb-0">{{ agenda_overdue|length }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100 border-warning">
          <div class="card-body">
            <div class="small text-muted">Vencem hoje</div>
            <div class="h5 mb-0">{{ agenda_today|length }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100 border-primary">
          <div class="card-body">
            <div class="small text-muted">Próximos 7 dias</div>
            <div class="h5 mb-0">{{ agenda_next_7_days|length }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      {% for item in obligations_agenda %}
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h3 class="h6 mb-0">{{ item.title }}</h3>
              {% if item.bucket == 'overdue' %}
                <span class="badge text-bg-danger">Atrasado</span>
              {% elif item.bucket == 'today' %}
                <span class="badge text-bg-warning">Hoje</span>
              {% elif item.bucket == 'next_7_days' %}
                <span class="badge text-bg-primary">Próx. 7 dias</span>
              {% else %}
                <span class="badge text-bg-success">Planejado</span>
              {% endif %}
            </div>
            <div class="small text-muted">Vencimento: {{ item.due_date|fmt_date }}</div>
            <div class="small">{{ item.reminder }}</div>
            <div class="lav-meta mt-1">{{ item.why }}</div>
            {% if item.resolution_steps %}
              <div class="small mt-2"><strong>Como resolver agora:</strong></div>
              <div class="small">
                {% for step in item.resolution_steps %}
                  <div>{{ step }}</div>
                {% endfor %}
              </div>
            {% endif %}
            <a class="btn btn-sm btn-outline-primary mt-2" href="{{ item.action_url }}">{{ item.action_label }}</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Próxima ação recomendada</h2>
      <div class="lav-meta">Assistente de fechamento: o sistema indica o próximo passo com maior impacto</div>
    </div>

    {% if recommended_action %}
      <div class="lav-callout is-warning mb-3">
        <strong>Foco agora:</strong> {{ recommended_action.title }}
        <div class="small">{{ recommended_action.help }}</div>
      </div>
      <a class="btn btn-primary" href="{{ recommended_action.action_url }}">{{ recommended_action.action_label }}</a>
    {% else %}
      <div class="lav-callout is-success">
        <strong>Parabéns:</strong> não há pendências principais no checklist.
        <div class="small">Se todos os documentos estiverem conferidos, você pode marcar a competência como fechada.</div>
      </div>
    {% endif %}

    {% if critical_pending_items %}
      <hr>
      <div class="small text-muted mb-1">Pendências críticas para liberar o fechamento:</div>
      <div class="mb-0 small">
        {% for item in critical_pending_items %}
          <div><strong>{{ item.title }}</strong> — {{ item.help }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Compliance-check (auditoria rápida)</h2>
      <div class="lav-meta">Verifica regras trabalhistas e consistência fiscal antes do fechamento</div>
    </div>
    <div class="small lav-subtitle mb-3">
      Use primeiro o modo padrão para auditar. Se as tabelas INSS/IRRF estiverem incompletas, você pode habilitar a atualização automática durante a checagem.
    </div>

    <form method="post" action="{{ url_for('payroll.close_run_compliance') }}" class="d-flex gap-2 flex-wrap">
      <input type="hidden" name="year" value="{{ year }}">
      <input type="hidden" name="month" value="{{ month }}">
      <button class="btn btn-outline-primary" type="submit" name="apply_sync" value="0">Rodar compliance-check</button>
      <button class="btn btn-primary" type="submit" name="apply_sync" value="1">Rodar + atualizar tabelas fiscais</button>
    </form>

    {% if compliance_result %}
      <hr>
      <div class="small mb-2">
        {% if compliance_result.ok %}
          <span class="badge text-bg-success">Sem alertas</span>
        {% else %}
          <span class="badge text-bg-warning">{{ compliance_result.issues_count }} alerta(s)</span>
        {% endif %}
      </div>

      {% if compliance_result.sync_report_lines %}
        <label class="form-label" for="sync_report_close">Relatório da atualização fiscal</label>
        <textarea id="sync_report_close" class="form-control mb-2" rows="8" readonly>{% for ln in compliance_result.sync_report_lines %}{{ ln }}
{% endfor %}</textarea>
      {% endif %}

      <label class="form-label" for="compliance_report_close">Relatório do compliance-check</label>
      <textarea id="compliance_report_close" class="form-control" rows="8" readonly>{% for ln in compliance_result.report_lines %}{{ ln }}
{% endfor %}</textarea>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Prazos legais do mês (semáforo)</h2>
      <div class="lav-meta">Verde = no prazo, amarelo = vence em breve, vermelho = atrasado</div>
    </div>
    <div class="small lav-subtitle mb-3">
      Estes prazos apoiam sua rotina de fechamento. Quando houver guia oficial com vencimento preenchido, ela prevalece no cálculo de status.
    </div>

    <div class="row g-3">
      {% for item in legal_deadlines %}
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">{{ item.title }}</h3>
              {% if item.status == 'danger' %}
                <span class="badge text-bg-danger">Atrasado</span>
              {% elif item.status == 'warning' %}
                <span class="badge text-bg-warning">Vence em breve</span>
              {% else %}
                <span class="badge text-bg-success">No prazo</span>
              {% endif %}
            </div>

            <div class="small text-muted">Vencimento: {{ item.due_date|fmt_date }}</div>
            <div class="small text-muted">Pago em: {{ item.paid_at|fmt_date }}</div>
            <div class="small mt-2">{{ item.note }}</div>
            <div class="lav-meta mt-2">{{ item.source }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Checklist guiado</h2>
      <div class="lav-meta">Objetivo: deixar tudo conferido antes de pagar.</div>
    </div>
    <div class="small lav-subtitle mb-3">Cada card abaixo diz o que está pendente e te leva direto para a tela certa.</div>

    <div class="row g-3">
      {% for key, item in checklist.items() %}
      <div class="col-lg-4">
        <div class="card h-100 lav-check-card {% if item.ok %}is-ok{% else %}is-pending{% endif %}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h3 class="h6 mb-1">{{ item.title }}</h3>
              {% if item.ok %}
                <span class="badge text-bg-success">OK</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
            </div>
            <div class="small lav-subtitle mb-3">{{ item.help }}</div>

            {% if key == 'taxes' and item.meta %}
              <div class="lav-meta mb-3">
                INSS: {{ item.meta.inss_eff|fmt_date }}<br>
                IRRF: {{ item.meta.irrf_eff|fmt_date }}
              </div>
            {% endif %}

            {% if key == 'vacations' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registradas: {{ item.meta.count }} · Total bruto: R$ {{ '%.2f'|format(item.meta.total_gross or 0) }}
              </div>
            {% endif %}

            {% if key == 'thirteenth' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registrados: {{ item.meta.count }} · Total bruto: R$ {{ '%.2f'|format(item.meta.total_gross or 0) }}
              </div>
            {% endif %}

            {% if key == 'terminations' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registradas: {{ item.meta.count }} · Total bruto: R$ {{ '%.2f'|format(item.meta.total_gross or 0) }}
              </div>
            {% endif %}

            {% if key == 'leaves' and item.meta and item.meta.count > 0 %}
              <div class="lav-meta mb-3">
                Registros: {{ item.meta.count }}
              </div>
            {% endif %}

            <a class="btn btn-sm btn-outline-primary" href="{{ item.action_url }}">{{ item.action_label }}</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Resumo do mês (estimativa)</h2>
      <div class="lav-meta">Conferência rápida</div>
    </div>
    <div class="small lav-subtitle mb-3">
      Este resumo ajuda você a conferir o mês rapidamente. Os valores de INSS/IRRF aqui são <strong>estimativas</strong> baseadas na folha e nas tabelas configuradas.
    </div>

    {% if not summary %}
      <div class="text-muted small">Ainda não existe folha para esta competência. Crie a folha para ver o resumo.</div>
    {% else %}
      <div class="row g-3">
        <div class="col-md-3">
          <div class="small text-muted">Funcionários na folha</div>
          <div><strong>{{ summary.employees_count }}</strong></div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Total bruto</div>
          <div><strong>R$ {{ '%.2f'|format(summary.total_gross or 0) }}</strong></div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">INSS estimado (empregado)</div>
          <div>
            {% if summary.total_inss_est is none %}
              <span class="text-muted">— (tabelas não configuradas)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_inss_est) }}</strong>
            {% endif %}
          </div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">IRRF estimado</div>
          <div>
            {% if summary.total_irrf_est is none %}
              <span class="text-muted">— (tabelas/config não configuradas)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_irrf_est) }}</strong>
            {% endif %}
          </div>
        </div>
      </div>

      {% if vacations_summary and vacations_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">Férias no mês</div>
          <div><strong>{{ vacations_summary.count }}</strong> registro(s) · Total bruto: <strong>R$ {{ '%.2f'|format(vacations_summary.total_gross or 0) }}</strong></div>
        </div>
      </div>
      {% endif %}

      {% if thirteenth_summary and thirteenth_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">13º no mês</div>
          <div><strong>{{ thirteenth_summary.count }}</strong> registro(s) · Total bruto: <strong>R$ {{ '%.2f'|format(thirteenth_summary.total_gross or 0) }}</strong></div>
        </div>
      </div>
      {% endif %}

      {% if terminations_summary and terminations_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">Rescisões no mês</div>
          <div><strong>{{ terminations_summary.count }}</strong> registro(s) · Total bruto: <strong>R$ {{ '%.2f'|format(terminations_summary.total_gross or 0) }}</strong></div>
        </div>
      </div>
      {% endif %}

      {% if leaves_summary and leaves_summary.count > 0 %}
      <hr>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="small text-muted">Afastamentos no mês</div>
          <div><strong>{{ leaves_summary.count }}</strong> registro(s)</div>
        </div>
      </div>
      {% endif %}

      <hr>

      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="small text-muted">Líquido estimado (bruto - INSS - IRRF)</div>
          <div>
            {% if summary.total_net_est is none %}
              <span class="text-muted">— (configure as tabelas para calcular)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_net_est) }}</strong>
            {% endif %}
          </div>
        </div>
        <div class="lav-meta text-end">
          INSS: {{ summary.inss_eff|fmt_date }}<br>
          IRRF: {{ summary.irrf_eff|fmt_date }}
        </div>
      </div>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Guias do mês</h2>
      <div class="lav-meta">DAS, FGTS e Previdência</div>
    </div>
    <div class="small lav-subtitle mb-3">Objetivo: centralizar PDFs e valores para você conferir antes de pagar.</div>

    <div class="row g-3">
  {% for dtype, label in { 'darf': 'DARF (Receita Federal)', 'das': 'DAS (Simples Nacional)', 'fgts': 'FGTS Digital (GFD)' }.items() %}
  {% set doc = docs.get(dtype) %}
  {% set official = guides_catalog_map.get(dtype) %}
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h6 mb-1">{{ label }}</h2>
        <div class="small text-muted mb-3">{{ '%02d'|format(month) }}/{{ year }}</div>

        {% if official %}
          <div class="lav-callout is-info mb-3">
            <div class="small"><strong>Modo assistido oficial</strong></div>
            <div class="small">Fonte confiável: {{ official.portal_label }}</div>
            <a class="btn btn-sm btn-outline-secondary mt-2" target="_blank" rel="noopener" href="{{ official.portal_url }}">Abrir portal oficial</a>
            <div class="small mt-2">Passo a passo:</div>
            <div class="small">
              {% for step in official.steps %}
                <div>{{ step }}</div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if doc %}
          <div class="mb-2">
            {% if doc.filename %}
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="/media/guides/{{ doc.filename }}">Abrir PDF</a>
            {% else %}
              <span class="text-muted small">PDF ainda não anexado.</span>
            {% endif %}
          </div>
          <div class="mb-2">
            {% if doc.validation_status == 'danger' %}
              <span class="badge text-bg-danger">Validação: crítico</span>
            {% elif doc.validation_status == 'warning' %}
              <span class="badge text-bg-warning">Validação: atenção</span>
            {% elif doc.validation_status == 'ok' %}
              <span class="badge text-bg-success">Validação: OK</span>
            {% else %}
              <span class="badge text-bg-secondary">Validação: pendente</span>
            {% endif %}
          </div>
          <div class="small text-muted">{{ doc.validation_summary or 'Sem validação automática ainda.' }}</div>
          <div class="small text-muted">Última checagem: {{ doc.validation_checked_at|fmt_date }}</div>
          <div class="small text-muted">Valor: {{ ('R$ %.2f'|format(doc.amount)) if doc.amount else '-' }}</div>
          <div class="small text-muted">Vencimento: {{ doc.due_date|fmt_date }}</div>
          <div class="small text-muted mb-3">Pago em: {{ doc.paid_at|fmt_date }}</div>
        {% else %}
          <div class="text-muted small mb-3">Nenhuma informação registrada ainda.</div>
        {% endif %}

        <div class="small text-muted mb-3">
          Observação: por segurança, emissão/consulta oficial depende de autenticação no portal (gov.br/e-CAC/FGTS Digital).
        </div>

        <form method="post" action="{{ url_for('payroll.close_upload') }}" enctype="multipart/form-data">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <input type="hidden" name="doc_type" value="{{ dtype }}">

          <div class="mb-2">
            <label class="form-label" for="file_{{ dtype }}">PDF</label>
            <input class="form-control" type="file" id="file_{{ dtype }}" name="file" accept="application/pdf">
          </div>
          <div class="mb-2">
            <label class="form-label" for="amount_{{ dtype }}">Valor (opcional)</label>
            <input class="form-control js-money" id="amount_{{ dtype }}" name="amount" placeholder="Ex.: 392,41">
          </div>
          <div class="mb-2">
            <label class="form-label" for="due_{{ dtype }}">Vencimento (opcional)</label>
            <input class="form-control js-date" type="text" id="due_{{ dtype }}" name="due_date" placeholder="dd/mm/aaaa" inputmode="numeric">
          </div>
          <div class="mb-3">
            <label class="form-label" for="paid_{{ dtype }}">Pago em (opcional)</label>
            <input class="form-control js-date" type="text" id="paid_{{ dtype }}" name="paid_at" placeholder="dd/mm/aaaa" inputmode="numeric">
          </div>
          <button class="btn btn-primary" type="submit">Salvar</button>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="lav-section-title mb-2">
      <h2 class="h6 mb-0">Trilha de evidências (auditoria)</h2>
      <div class="lav-meta">Quem fez o quê e quando nesta competência</div>
    </div>
    {% if evidence_events %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Quando</th>
              <th>Evento</th>
              <th>Entidade</th>
              <th>Usuário</th>
              <th>Detalhes</th>
            </tr>
          </thead>
          <tbody>
            {% for ev in evidence_events %}
            <tr>
              <td class="small text-muted">{{ ev.created_at|fmt_date }}</td>
              <td><span class="badge text-bg-light border">{{ ev.event_type }}</span></td>
              <td class="small">{{ ev.entity_type }}{% if ev.entity_key %} / {{ ev.entity_key }}{% endif %}</td>
              <td class="small text-muted">{{ ev.actor_email or '-' }}</td>
              <td class="small text-muted">{{ ev.details or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="small text-muted">Sem eventos registrados nesta competência.</div>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    const askBtn = document.getElementById('ai-ask-close');
    const questionEl = document.getElementById('ai-question-close');
    const answerEl = document.getElementById('ai-answer-close');
    const closeYear = Number.parseInt('{{ year }}', 10);
    const closeMonth = Number.parseInt('{{ month }}', 10);
    if (!askBtn || !questionEl || !answerEl) return;

    askBtn.addEventListener('click', async function () {
      const question = (questionEl.value || '').trim();
      if (!question) {
        answerEl.textContent = 'Digite uma pergunta para o assistente.';
        return;
      }

      askBtn.disabled = true;
      answerEl.textContent = 'Consultando assistente...';
      try {
        const response = await fetch("{{ url_for('payroll.ai_assistant') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            source: 'close_home',
            year: closeYear,
            month: closeMonth,
            question: question
          })
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          answerEl.textContent = data.error || 'Não foi possível obter resposta agora.';
          return;
        }
        answerEl.textContent = data.answer || 'Sem resposta.';
      } catch (err) {
        answerEl.textContent = 'Falha de conexão com o assistente. Tente novamente.';
      } finally {
        askBtn.disabled = false;
      }
    });
  })();
</script>
{% endblock %}
