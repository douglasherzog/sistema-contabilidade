{% extends 'base.html' %}
{% block title %}Fechamento - Sistema Contabilidade{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">Fechamento</h1>
    <div class="text-muted small">Checklist do mês para você conferir se está tudo pronto antes de pagar as guias e encerrar a competência.</div>
  </div>
  <div class="d-flex gap-2">
    {% if closed %}
      <form method="post" action="{{ url_for('payroll.close_reopen') }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <button class="btn btn-outline-secondary" type="submit">Reabrir competência</button>
      </form>
    {% else %}
      <form method="post" action="{{ url_for('payroll.close_mark') }}">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
        <button class="btn btn-primary" type="submit">Marcar como fechada</button>
      </form>
    {% endif %}
  </div>
</div>

{% if closed %}
  <div class="alert alert-warning">
    <strong>Competência marcada como FECHADA.</strong>
    <div class="small">Isso não bloqueia alterações, mas o sistema vai te avisar quando você mexer em dados do mês para evitar inconsistências.</div>
  </div>
{% else %}
  <div class="alert alert-light border">
    <strong>Competência em aberto.</strong>
    <div class="small text-muted">Quando tudo estiver OK no checklist abaixo, você pode marcar como fechada para organização.</div>
  </div>
{% endif %}

<div class="card mb-3">
  <div class="card-body">
    <form method="get" action="{{ url_for('payroll.close_home') }}" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label" for="year">Ano</label>
        <input class="form-control" id="year" name="year" value="{{ year }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label" for="month">Mês</label>
        <input class="form-control" id="month" name="month" value="{{ month }}" required>
      </div>
      <div class="col-12">
        <button class="btn btn-outline-secondary" type="submit">Abrir competência</button>
      </div>
    </form>
  </div>
</div>

<div class="row g-3 mb-3">
  {% for key, item in checklist.items() %}
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <h2 class="h6 mb-1">{{ item.title }}</h2>
          {% if item.ok %}
            <span class="badge text-bg-success">OK</span>
          {% else %}
            <span class="badge text-bg-warning">Pendente</span>
          {% endif %}
        </div>
        <div class="small text-muted mb-3">{{ item.help }}</div>

        {% if key == 'taxes' and item.meta %}
          <div class="small text-muted mb-3">
            INSS: {{ item.meta.inss_eff|fmt_date }}<br>
            IRRF: {{ item.meta.irrf_eff|fmt_date }}
          </div>
        {% endif %}

        <a class="btn btn-sm btn-outline-primary" href="{{ item.action_url }}">{{ item.action_label }}</a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div class="card mb-3">
  <div class="card-body">
    <h2 class="h6 mb-2">Resumo do mês (estimativa)</h2>
    <div class="text-muted small mb-3">
      Este resumo ajuda você a conferir o mês rapidamente. Os valores de INSS/IRRF aqui são <strong>estimativas</strong> baseadas na folha e nas tabelas configuradas.
    </div>

    {% if not summary %}
      <div class="text-muted small">Ainda não existe folha para esta competência. Crie a folha para ver o resumo.</div>
    {% else %}
      <div class="row g-3">
        <div class="col-md-3">
          <div class="small text-muted">Funcionários na folha</div>
          <div><strong>{{ summary.employees_count }}</strong></div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Total bruto</div>
          <div><strong>R$ {{ '%.2f'|format(summary.total_gross or 0) }}</strong></div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">INSS estimado (empregado)</div>
          <div>
            {% if summary.total_inss_est is none %}
              <span class="text-muted">— (tabelas não configuradas)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_inss_est) }}</strong>
            {% endif %}
          </div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">IRRF estimado</div>
          <div>
            {% if summary.total_irrf_est is none %}
              <span class="text-muted">— (tabelas/config não configuradas)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_irrf_est) }}</strong>
            {% endif %}
          </div>
        </div>
      </div>

      <hr>

      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="small text-muted">Líquido estimado (bruto - INSS - IRRF)</div>
          <div>
            {% if summary.total_net_est is none %}
              <span class="text-muted">— (configure as tabelas para calcular)</span>
            {% else %}
              <strong>R$ {{ '%.2f'|format(summary.total_net_est) }}</strong>
            {% endif %}
          </div>
        </div>
        <div class="small text-muted text-end">
          INSS: {{ summary.inss_eff|fmt_date }}<br>
          IRRF: {{ summary.irrf_eff|fmt_date }}
        </div>
      </div>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  {% for dtype, label in { 'darf': 'DARF (Receita Federal)', 'das': 'DAS (Simples Nacional)', 'fgts': 'FGTS Digital (GFD)' }.items() %}
  {% set doc = docs.get(dtype) %}
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h6 mb-1">{{ label }}</h2>
        <div class="small text-muted mb-3">{{ '%02d'|format(month) }}/{{ year }}</div>

        {% if doc %}
          <div class="mb-2">
            {% if doc.filename %}
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="/media/guides/{{ doc.filename }}">Abrir PDF</a>
            {% else %}
              <span class="text-muted small">PDF ainda não anexado.</span>
            {% endif %}
          </div>
          <div class="small text-muted">Valor: {{ ('R$ %.2f'|format(doc.amount)) if doc.amount else '-' }}</div>
          <div class="small text-muted">Vencimento: {{ doc.due_date|fmt_date }}</div>
          <div class="small text-muted mb-3">Pago em: {{ doc.paid_at|fmt_date }}</div>
        {% else %}
          <div class="text-muted small mb-3">Nenhum PDF anexado.</div>
        {% endif %}

        <form method="post" action="{{ url_for('payroll.close_upload') }}" enctype="multipart/form-data">
          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">
          <input type="hidden" name="doc_type" value="{{ dtype }}">

          <div class="mb-2">
            <label class="form-label" for="file_{{ dtype }}">PDF</label>
            <input class="form-control" type="file" id="file_{{ dtype }}" name="file" accept="application/pdf">
          </div>
          <div class="mb-2">
            <label class="form-label" for="amount_{{ dtype }}">Valor (opcional)</label>
            <input class="form-control" id="amount_{{ dtype }}" name="amount" placeholder="Ex.: 190,00">
          </div>
          <div class="mb-2">
            <label class="form-label" for="due_{{ dtype }}">Vencimento (opcional)</label>
            <input class="form-control" type="date" id="due_{{ dtype }}" name="due_date">
          </div>
          <div class="mb-3">
            <label class="form-label" for="paid_{{ dtype }}">Pago em (opcional)</label>
            <input class="form-control" type="date" id="paid_{{ dtype }}" name="paid_at">
          </div>
          <button class="btn btn-primary" type="submit">Salvar</button>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}
